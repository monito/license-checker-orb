description: >
  Drop-in job to validate the licenses used in production.
  A list of forbidden licenses can be provided. If one of the license is found the build will fail.
  A CSV report with all licences is uploaded as a build artifact.

parameters:
  app-dir:
    type: string
    default: .
    description: The location of the package.json and associated node_modules
  node-version:
    type: string
    default: 14.16.1
    description: >
      A full node version tag must be specified. Example: 14.16.1
      For a full list of releases, see the following: https://nodejs.org/en/download/releases
  pkg-manager:
    type: enum
    enum: [npm, yarn]
    default: yarn
    description: The package manager to use to install the node modules
  override-ci-command:
    type: string
    default: ""
    description: >
      By default, packages will be installed with "npm ci", "yarn install --frozen-lockfile" or "yarn install --immutable".
      Optionally supply a custom package installation command, with any additional flags needed.
  forbidden:
    type: string
    default: ""
    description: >
      A semi colon separated list of forbidden licenses.
      If no value is provided the license check won't fail.

executor:
  name: default
  tag: << parameters.node-version >>

steps:
  - install
  - checkout
  - node/install-packages:
      pkg-manager: << parameters.pkg-manager >>
      app-dir: << parameters.app-dir >>
      override-ci-command: << parameters.override-ci-command >>
  - run:
      name: Production License Check
      command: npx license-checker --production --summary --excludePrivatePackages --failOn "<< parameters.forbidden >>"
      working_directory: << parameters.app-dir >>
  - run:
      name: Production license summary
      command: npx license-checker --production --summary --excludePrivatePackages
      working_directory: << parameters.app-dir >>
      when: on_fail
  - run:
      name: Build production license report
      command: npx license-checker --production --excludePrivatePackages --csv > /tmp/license-checker-report.csv
      working_directory: << parameters.app-dir >>
      when: always
  - store_artifacts:
      path: /tmp/license-checker-report.csv
      when: always
